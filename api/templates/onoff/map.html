{% extends "onoff/base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="../static/lib/leaflet/leaflet.css" />
<!--script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script-->
<script src="../static/lib/leaflet/leaflet-src.js"></script>
<script src="../static/js/map.js"></script>
{% endblock %}


{% block dashboard %}

{{ super() }}
<table>
  <tr>
    <td>
      <div class="btn-group" style="z-index:1000" role="form">
        <button id="line-btn" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
        Select Route    <span class="caret"></span>
        </button>
        <ul id="filter_line" class="dropdown-menu scrollable-menu" role="menu">
          <li role="presentation" class="dropdown-header">Route</li>
          <li role="presentation" class="divider"></li>
          {% for route in routes %}
          <li><a href="#">{{ route }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </td>
  </tr>
</table>
<br>
<div style="margin:2px">
  <ul id="dir-tabs" class="nav nav-tabs" style="display:none">
    <li id="inbound-link" role="presentation" class="active"><a href="#">Inbound</a></li>
    <li id="outbound-link" role="presentation"><a href="#">Outbound</a></li>
  </ul>
  <div id="map" style="width:100%; height:60vh; z-index:1"></div>
</div>
<script>
    var active = {'route':null, 'tad':null};
    var routes = {'in':null, 'out':null};
    var tads = {'in':null, 'out':null};
    var stops;

    $('#filter_line a').on('click', function() {
        //setup html views
        $("#line-btn").text(this.text+' ').append('<span class="caret"></span>');
        var dir = dir_lookup[this.text];
        $("#outbound-link > a").text(dir[0]);
        $("#inbound-link > a").text(dir[1]);
        $('#outbound-link').removeClass('active');
        $('#inbound-link').addClass('active');
        $("#dir-tabs").show();
        var args = {"rte_desc":this.text};
        
        //fetch route stats
        $.getJSON('map/_details', args, function(data) {
            if (active.route) map.removeLayer(active.route);
            if (active.tad) map.removeLayer(active.tad);
            var opt = jQuery.extend(true, {}, options);
            opt.color = '#424559';
            opt.weight = 4;
            opt.clickable = false;
            delete opt.radius;
            out_routes = new L.geoJson(data.routes[0].geom, opt);
            in_routes = new L.geoJson(data.routes[1].geom, opt);
            outbound = build_dir_feature(data.data[0], data.time_data[0]);
            inbound = build_dir_feature(data.data[1], data.time_data[1]);   
            activate_dir(inbound, in_routes); 
        }); 
    });

    function activate_dir(layer, routes) {
        if (active.route) map.removeLayer(active.route);
        if (active.tad) map.removeLayer(active.tad);
        active.route = routes;
        active.tad = layer;
        map.addLayer(routes);
        map.addLayer(layer);
        map.fitBounds(layer.getBounds());
    }

    var tad_stops = {};

    function show_stops(tad) {
        map.addLayer(tad_stops[tad]);
    }

    function hide_stops(tad) {
        map.removeLayer(tad_stops[tad]);
    }

    function build_dir_feature(data, time_data) {
        var fc = {
            "type":"FeatureCollection",
            "features":[]
        };
       
        $(data).each(function(index, item) {
            var geo = JSON.parse(item.centroid);
            var prop = {};
            prop.tad = item.tad;
            prop.count = item.count;
            prop.ons = item.ons;
            prop.time = time_data[item.tad];
            geo.properties = prop;
            fc.features.push(geo);
            tad_stops[item.tad] = new L.geoJson(JSON.parse(item.stops), {
                pointToLayer:pointFunctionStops
            });
        });
        return new L.geoJson(fc, {
            pointToLayer:pointFunctionTads,
            onEachFeature:onEachFeature 
        });
    }
 
    $('#dir-tabs > li > a').click( function() {
        $('#dir-tabs > li.active').removeClass('active');
        $(this).parent().addClass('active');
        var link = $(this).parent().attr('id');
        if(link == 'outbound-link') activate_dir(outbound, out_routes);
        if(link == 'inbound-link') activate_dir(inbound, in_routes);
    });

    var directions = {{ directions|tojson|safe }};
    var dir_lookup = {};
    
    $(directions).each(function(index, item) {
        if(!dir_lookup.hasOwnProperty(item.rte_desc)) {
            dir_lookup[item.rte_desc] = {};
        }
        dir_lookup[item.rte_desc][item.dir] = item.dir_desc;
    });

    var map = initmap('map');
    var stats = new L.geoJson().addTo(map);

    var status_color = {
        'status-1':'rgba(219,85,85,0.8)',
        'status-2':'rgba(212,162,70,0.8)',
        'status-3':'rgba(204,255,51,0.8)',
        'status-4':'rgba(161,237,68,0.8)',
        'status-complete':'rgba(118,219,85,0.8)',
        'status-none':'rgba(219,217,217,0.6)'
    };

    var red = '#D62020';
    var green = '#26D620';
    var blue = '#2035D6';
    var orange = '#D69020';
    var black =' #000';

    var options = {
        radius: 8,
        color: black,
        weight: 1,
        opacity: 1,
        fillOpacity: 1
    };

    function get_pct_text(pct) {
        var text;
        if(pct < 0) text = 'N/A';
        //else if(pct > 100) text = "100%";
        else text = pct.toString() + "%";
        return text;
    }

    function build_cell(label, pct) {
        pct = Math.round(pct);
        var td = $('<td>'); 
        if(label) {
            td.attr("class", get_status(pct));
            td.text(label);
            td.attr("align", "center");
        }
        else {
            label = get_pct_text(pct);
            td.attr("class", get_status(pct));
            td.text(label);
            td.attr("align", "center");
        }
        return td;
    }
        
    function get_pct(count, quota) {
        if(count == null) return 0;
        if(quota == null) return null;
        return (count / quota ) * 100;
    }

    function get_status(pct_complete) {
        var cls = "";
        if(pct_complete < 0)
            return "status-none";
        switch (Math.floor(pct_complete / 25) + 1) {
            case 1: //0% -> 24%
                cls = "status-1"; break;
            case 2: //25% -> 49%
                cls = "status-2"; break;
            case 3: //50% -> 74%    
                cls = "status-3"; break;
            case 4: //75% -> 99%    
                cls = "status-4"; break;
            default: //100% +    
                cls = "status-complete";
        }
        return cls;
    }

    var pointFunctionStops = function (feature, latlng) {
        var opt = jQuery.extend(true, {}, options);
        opt.fillColor = blue;
        opt.radius = 4;
        opt.clickable = false;
        var marker = new L.circleMarker(latlng, opt);
        return marker;
    }

    var pointFunctionTads = function (feature, latlng) {
        var opt = jQuery.extend(true, {}, options);
        var code = get_status(get_pct(
            feature.properties.count,
            feature.properties.ons
        ));
        opt.fillColor = status_color[code];
        opt.radius =  Math.log(feature.properties.ons) / Math.log(10) * 10;
        var marker = new L.circleMarker(latlng, opt);
        marker.on('mouseover', function(e) {
            var feature = e.target.feature.geometry;
            show_stops(feature.properties.tad);
            marker.openPopup();
            marker.options.color = blue;
        });
        marker.on('mouseout', function(e) {
            var feature = e.target.feature.geometry;
            hide_stops(feature.properties.tad);
            marker.closePopup();
            marker.options.color = black;
        });
        return marker;
    }

    var headers = ['', '', '6a-9a','9a-12p','12p-3p','3p-6p','6p-9p','9p-12a'];
    var onEachFeature = function (feature, layer) {
        if (feature.properties) {
            var row1 = $('<tr>'); 
            var row2 = $('<tr>');
            var row3 = $('<tr>');
            var count = Math.round(feature.properties.count);
            var ons = Math.round(feature.properties.ons);
            var pct = (count / ons) * 100;
            var complete = Math.round(pct).toString() + '% ' +
                count + '/' + ons;
            var cell = build_cell(complete, pct).attr('colspan', '6');
            var row4 = $('<tr>').append(cell);
            //console.log(feature.properties.time);
            $(headers).each(function(index, item) {
                if(index > 1) {
                    var pct;
                    var feat = feature.properties.time[index];
                    var num_text = 'N/A';
                    if(feat) {
                        if(!feat.ons) pct = -1;
                            else if(!feat.count) {
                                num_text = 0 + '/' + Math.round(feat.ons);
                                pct = 0;
                            }
                            else {
                                pct = (feat.count / feat.ons) * 100;
                                num_text = Math.round(feat.count) + '/' + 
                                    Math.round(feat.ons);
                            }
                        }
                    else pct = -1;
                    var header = build_cell(headers[index], pct);
                    var cell1 = build_cell(null, pct);   
                    var cell2 = build_cell(num_text ,pct);
                    row1.append(header);
                    row2.append(cell1);
                    row3.append(cell2);
                    
                }
            });
            //row3.append(

            var popup_html = $('<div>')
                .addClass("table-responsive panel panel-default")
                .append(
                    $('<table>').addClass('table')
                        .append(row1)
                        .append(row2)
                        .append(row3)
                        .append(row4)
                ).html();
            var popup = L.popup({'minWidth':320})
                .setContent(popup_html);
            layer.bindPopup(popup);
        }
    }


</script>


{% endblock %}
