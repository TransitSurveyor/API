{% extends "onoff/base.html" %}

{% block head %}
{{ super() }}
<script src="//code.highcharts.com/highcharts.js"></script>
<!--script src="../static/js/charts.js"></script-->


{% endblock %}


{% block dashboard %}
{{ super() }}

<!-- dropdowns that trigger ajax call to update table based on selection -->
<table>
  <tr>
    <td style="padding-right:1em">
      <strong>Route:</strong>
    </td>
    <td>
      <div class="btn-group">
        <button id="line_btn" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
        All    <span class="caret"></span>
        </button>
        <ul id="filter_line" class="dropdown-menu scrollable-menu" role="menu">
          <li role="presentation" class="dropdown-header">Route</li>
          <li role="presentation"><a href="#">All</a></li>
          <li role="presentation" class="divider"></li>

          <!-- func views.py::status()
                 func results from helper.py::Query.routes()

               returns a list of all routes that are queryable -->
          {% for route in routes %}
          <li><a href="#">{{ route }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </td>
  </tr>
</table>

<!--div class="table-responsive">
  <table class="table table-striped">
    <thead id="thead">
      <tr>
        <th>Route</th>
        <th>Complete</th>
        <th>Target</th>
        <th>Percent</th>
      </tr>
    </thead> 
    <tbody id="status_table">
    </tbody>
  </table>
</div-->


<!-- container for chart -->
<div id="status_chart" style="margin: 0 auto"></div>

<script>

    function build_options(container, title, categories, series) {
        //size of columns in chart
        var pointWidth = 50;
        //set height of chart dynamically
        var h = (pointWidth + 10) * 1 * categories.length + 50 + 70;
        // + 10- distance between bars
        // * 2 - number of series
        // +50+70 - margins top + bottom
        // n - number of points
        return {
            chart: {
                type: 'bar',
                renderTo: container,
                height:h
            },
            title: {
                text: title
            },
            xAxis: {
                categories:categories
            },
            yAxis: {
                min: 0,
                max: 100,
                title: {
                    text: 'Percentage'
                }
            },
            legend: {
                reversed: true
            },
            plotOptions: {
                series: {
                    stacking: 'Percent'
                }
            },
            series:series
        }
    }
    

    function build_cell(data) {
        return '<td>' + data +'</td>';
    }

    function pct_complete(complete, target) {
        var pct = Math.round((complete / target) * 100)
        return build_cell(String(pct)+'%');
    }

    function build_status_row(item) {
        var rte_desc = build_cell(item.rte_desc);
        var complete = build_cell(item.count);
        var target = build_cell(item.target);
        var pct = pct_complete(item.count, item.target);
        return '<tr>'+rte_desc+complete+target+pct+'</tr>';
    }
    
    function build_targets_table(data) {
        $(data).each(function(index, item) {
            var row = build_status_row(item);
            console.log(item);
            $("#status_table").append(row);
        });
    }

    //var targets = {{ targets|tojson|safe }};
    //build_targets_table(targets)
    
    var chart;
    var chart_data = {{ chart|tojson|safe }};
    var options = build_options(
        'status_chart', "This is a label", chart_data.categories, chart_data.series);
    chart = new Highcharts.Chart(options);

</script>
{% endblock %}

