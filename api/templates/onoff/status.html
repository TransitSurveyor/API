{% extends "onoff/base.html" %}

{% block head %}
{{ super() }}
<script src="http://code.highcharts.com/highcharts.js"></script>
{% endblock %}


{% block sidebar %}
{{ super() }}
<ul class="nav nav-sidebar">
  <li class="dropdown">
    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
      Routes <span class="caret"></span>
    </a>
    <ul id="lines" class="dropdown-menu" role="menu">
      {% for route in routes %}
      <li><a href="#">{{ route }}</a></li>
      {% endfor %}
    </ul>
  </li>
</ul>
{% endblock %}


{% block dashboard %}
{{ super() }}

<!-- dropdowns that trigger ajax call to update table based on selection -->
<table>
  <tr>
    <td style="padding-right:1em">
      <strong>Route:</strong>
    </td>
    <td>
      <div class="btn-group">
        <button id="line_btn" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
        All    <span class="caret"></span>
        </button>
        <ul id="filter_line" class="dropdown-menu scrollable-menu" role="menu">
          <li role="presentation" class="dropdown-header">Route</li>
          <li role="presentation"><a href="#">All</a></li>
          <li role="presentation" class="divider"></li>
          {% for route in routes %}
          <li><a href="#">{{ route }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </td>
  </tr>
</table>

<!-- container for chart -->
<div id="status_chart" style="margin: 0 auto"></div>

<script>
    var chart;

    function build_options(container, title, categories, series) {
        var pointWidth = 30;
        var h = (pointWidth + 10) * 1 * categories.length + 50 + 70;
        // + 10- distance between bars
        // * 2 - number of series
        // +50+70 - margins top + bottom
        // n - number of points
        return {
            chart: {
                type: 'bar',
                renderTo: container,
                height:h
            },
            title: {
                text: title
            },
            xAxis: {
                categories:categories
            },
            yAxis: {
                min: 0,
                max: 100,
                title: {
                    text: 'Percentage'
                }
            },
            legend: {
                reversed: true
            },
            plotOptions: {
                series: {
                    stacking: 'Percent'
                }
            },
            series:series
        }
    }

    function draw_chart(args) {
        var url = "status/_details";
        
        $.getJSON(url, args, function (data) {
            var label = 'Current Status';
            if (args.hasOwnProperty('line')) {
                label = 'Route ' + args.line;
            }
            var options = build_options(
                'status_chart', label, data.categories, data.series);
            chart = new Highcharts.Chart(options);
        });
    }


    $('#filter_line a').on('click', function() {
        $("#line_btn").text(this.text+' ').append('<span class="caret"></span>');
        args = {};
        if (this.text != 'All') {
            args['line'] = this.text;
        }
        draw_chart(args);
    });

    draw_chart({});
</script>
{% endblock %}

